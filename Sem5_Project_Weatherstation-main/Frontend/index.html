<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Weather Stations with Interactive Map</title>

  <!-- Leaflet & MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <!-- Leaflet & MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      font-family: Arial, sans-serif;
    }

    /* =========== TOP CONTROLS LEISTE =========== */
    .top-controls {
      width: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 10px 20px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: flex-start;
      z-index: 9999;
    }
    fieldset {
      border: 1px solid #ccc;
      padding: 10px 15px;
      border-radius: 5px;
    }
    fieldset legend {
      font-weight: bold;
      padding: 0 5px;
    }
    fieldset label {
      margin-right: 5px;
    }
    fieldset input {
      width: 70px;
      margin-right: 10px;
      height: 25px;
      font-size: 14px;
    }
    fieldset button {
      margin-right: 10px;
      height: 30px;
      font-size: 14px;
    }

    /* =========== MAP =========== */
    #map {
      width: 100%;
      height: 60%; /* 60% für Karte */
    }

    /* =========== STATIONSLISTE =========== */
    #stationsList {
      padding: 20px;
      height: calc(40% - 20px);
      overflow-y: auto;
    }
    .station-table-container {
      overflow-y: auto;
      max-height: 300px;
    }
    .station-table-container table {
      width: 100%;
      border-collapse: collapse;
    }
    .station-table-container th,
    .station-table-container td {
      padding: 10px;
      border: 1px solid #ddd;
    }
    .station-table-container th {
      background-color: #f4f4f4;
    }
    .station-table-container tr:hover {
      background-color: #f1f1f1;
    }

    /* =========== LADEOVERLAY (SPINNER) =========== */
    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(255,255,255,0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      border: 10px solid #f3f3f3;
      border-top: 10px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* =========== SIDEBAR (Station-Details, zwischen Top & Table) =========== */
    .sidebar {
      position: fixed;
      /* Sidebar zwischen top-controls und stationsList.
         Hier nehmen wir an, die top-controls haben ~110px Höhe 
         und stationsList beginnt ~60% vom Bildschirm.
         Du kannst die Werte ggf. anpassen. */
      top: 120px; 
      bottom: 180px; /* so bleibt es oberhalb des stationsList-Bereiches */
      right: -300px; /* Start versteckt */
      width: 280px;
      background-color: #fff;
      border-left: 1px solid #ccc;
      padding: 15px;
      box-shadow: -3px 0 5px rgba(0,0,0,0.2);
      transition: right 0.3s;
      z-index: 9999;
      overflow: auto; /* falls Text / Sliders größer wird */
    }
    .sidebar.open {
      right: 0; /* Sichtbar, wenn Klasse "open" */
    }
    .sidebar h2 {
      margin-bottom: 10px;
    }
    .sidebar label {
      display: block;
      margin-top: 10px;
      font-weight: normal;
    }
    .sidebar .slider-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 5px;
    }
    #closeSidebarBtn {
      margin-top: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- ========== LADESPINNER OVERLAY ========== -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- ========== TOP CONTROLS LEISTE ========== -->
  <div class="top-controls">
    <fieldset>
      <legend>Radius Settings</legend>
      <label for="radius">Radius (km):</label>
      <input type="number" id="radius" value="50" min="1" />
      
      <label for="maxStations">Max Stations:</label>
      <input type="number" id="maxStations" value="10" min="1" />

      <button onclick="updateRadius()">Apply Radius</button>
      <button onclick="removeRadius()">Remove Radius</button>
    </fieldset>

    <fieldset>
      <legend>Coordinate Search</legend>
      <label for="searchLat">Lat:</label>
      <input type="number" id="searchLat" step="0.0001" placeholder="48.7094" />
      <label for="searchLng">Lng:</label>
      <input type="number" id="searchLng" step="0.0001" placeholder="-94.5853"/>
      
      <button onclick="searchByCoordinates()">Search by Coords</button>
    </fieldset>
  </div>

  <!-- ========== MAP ========== -->
  <div id="map"></div>

  <!-- ========== STATIONSLISTE ========== -->
  <div id="stationsList">
    <h3>Stations</h3>
    <div class="station-table-container">
      <table id="stationTable" class="station-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Start Year</th>
            <th>End Year</th>
            <th>Distance (km)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ========== SIDEBAR (STATION-DETAILS & DOPPELSLIDER) ========== -->
  <div id="sidebar" class="sidebar">
    <h2>Station Info</h2>
    <p><strong>ID:</strong> <span id="sidebarStationId"></span></p>
    <p><strong>Coords:</strong> <span id="sidebarStationCoords"></span></p>
    <p><strong>Zeitraum:</strong> <span id="sidebarStationYears"></span></p>

    <!-- Zwei Slider: Minimales und maximales Jahr -->
    <label>Wähle Start- und Endjahr:</label>

    <!-- Min-Jahr-Slider -->
    <div class="slider-container">
      <input 
        type="range" 
        id="yearSliderMin" 
        step="1" 
        oninput="updateYearRangeSliders()" 
      />
      <span id="yearSliderMinVal"></span>
    </div>

    <!-- Max-Jahr-Slider -->
    <div class="slider-container">
      <input 
        type="range" 
        id="yearSliderMax" 
        step="1" 
        oninput="updateYearRangeSliders()" 
      />
      <span id="yearSliderMaxVal"></span>
    </div>

    <button id="closeSidebarBtn" onclick="closeSidebar()">Schließen</button>
  </div>

  <script>
    // =================== LEAFLET-KARTE ===================
    var map = L.map("map").setView([51.505, -0.09], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "© OpenStreetMap contributors",
    }).addTo(map);

    var markers = L.markerClusterGroup();
    var currentTableData = [];
    var radiusActive = false;
    var currentRadiusCircle = null;
    var currentCenterMarker = null;
    var radiusKm = 0;

    // SIDEBAR-Referenzen
    var sidebar = document.getElementById("sidebar");
    var sidebarStationId = document.getElementById("sidebarStationId");
    var sidebarStationCoords = document.getElementById("sidebarStationCoords");
    var sidebarStationYears = document.getElementById("sidebarStationYears");

    var yearSliderMin = document.getElementById("yearSliderMin");
    var yearSliderMax = document.getElementById("yearSliderMax");
    var yearSliderMinVal = document.getElementById("yearSliderMinVal");
    var yearSliderMaxVal = document.getElementById("yearSliderMaxVal");

    // ============ LADESPINNER ============
    function showLoading() {
      document.getElementById("loadingOverlay").style.display = "flex";
    }
    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    // ============ TABELLE =============
    function populateStationTable(data) {
      var tableBody = document.querySelector("#stationTable tbody");
      tableBody.innerHTML = "";

      data.forEach(station => {
        var row = document.createElement("tr");
        row.innerHTML = `
          <td>${station.station_id}</td>
          <td>${station.latitude}</td>
          <td>${station.longitude}</td>
          <td>${station.start_year}</td>
          <td>${station.end_year}</td>
          <td>${station.distance ? station.distance.toFixed(2) : "-"}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    // ============ MARKERCLUSTER + MARKER-CLICK =============
    function showStationsOnMap(data) {
      markers.clearLayers();

      data.forEach(st => {
        var marker = L.marker([st.latitude, st.longitude]);
        
        // Klick-Event => openSidebar
        marker.on("click", function() {
          openSidebar(st);
        });

        markers.addLayer(marker);
      });

      map.addLayer(markers);
    }

    // ============ SIDEBAR FUNKTIONEN (Marker-Klick => openSidebar) ============
    function openSidebar(station) {
      // Station-Info in Sidebar schreiben
      sidebarStationId.textContent = station.station_id;
      sidebarStationCoords.textContent = station.latitude + ", " + station.longitude;
      sidebarStationYears.textContent = station.start_year + " - " + station.end_year;

      // Min-Jahr-Slider
      yearSliderMin.min = station.start_year;
      yearSliderMin.max = station.end_year;
      yearSliderMin.value = station.start_year;  // default

      // Max-Jahr-Slider
      yearSliderMax.min = station.start_year;
      yearSliderMax.max = station.end_year;
      yearSliderMax.value = station.end_year;    // default

      // Anzeige aktualisieren
      yearSliderMinVal.textContent = station.start_year;
      yearSliderMaxVal.textContent = station.end_year;

      // Sidebar einblenden
      sidebar.classList.add("open");
    }

    function closeSidebar() {
      sidebar.classList.remove("open");
    }

    // Wird aufgerufen, wenn einer der beiden Slider bewegt wird
    function updateYearRangeSliders() {
      // Achte darauf, dass der Min-Slider nie über den Max-Slider hinausgeht
      if (parseInt(yearSliderMin.value) > parseInt(yearSliderMax.value)) {
        yearSliderMin.value = yearSliderMax.value;
      }

      yearSliderMinVal.textContent = yearSliderMin.value;
      yearSliderMaxVal.textContent = yearSliderMax.value;

      // Hier könntest du später z. B. 
      // => Server-Abfrage für Daten in dem Zeitraum 
      // => oder Filter, etc.
    }

    // ============ BOUNDING BOX =============
    map.on("moveend", () => {
      if (!radiusActive) {
        handleMapMove();
      }
    });

    function handleMapMove() {
      showLoading();
      var bounds = map.getBounds();
      var sw = bounds.getSouthWest();
      var ne = bounds.getNorthEast();

      var url = `/stations_in_bounds?swLat=${sw.lat}&swLng=${sw.lng}&neLat=${ne.lat}&neLng=${ne.lng}`;
      fetch(url)
        .then(r => {
          if (!r.ok) throw new Error("BBox-Request fehlgeschlagen");
          return r.json();
        })
        .then(data => {
          currentTableData = data;
          populateStationTable(data);
          showStationsOnMap(data);
        })
        .catch(err => console.error("BBox-Fetch Fehler:", err))
        .finally(() => hideLoading());
    }

    // ============ RADIUS CLICK =============
    function updateRadius() {
      radiusKm = parseFloat(document.getElementById("radius").value);
      radiusActive = true;
      map.once("click", (e) => {
        drawRadiusAndFilter(e.latlng.lat, e.latlng.lng, currentTableData);
      });
      alert("Klicke auf die Karte, um den Mittelpunkt des Radius festzulegen.");
    }

    function drawRadiusAndFilter(centerLat, centerLng, data) {
      if (currentRadiusCircle) map.removeLayer(currentRadiusCircle);
      if (currentCenterMarker) map.removeLayer(currentCenterMarker);

      currentRadiusCircle = L.circle([centerLat, centerLng], {
        radius: radiusKm * 1000,
        color: "blue",
        fillColor: "#add8e6",
        fillOpacity: 0.5,
      }).addTo(map);

      currentCenterMarker = L.circleMarker([centerLat, centerLng], {
        radius: 5,
        color: "red",
        fillColor: "red",
        fillOpacity: 1
      }).addTo(map);

      var filtered = data.map(st => {
        var d = getDistance(centerLat, centerLng, parseFloat(st.latitude), parseFloat(st.longitude));
        return { ...st, distance: d };
      }).filter(st => st.distance <= radiusKm);

      filtered.sort((a,b) => a.distance - b.distance);
      currentTableData = filtered;
      populateStationTable(filtered);
      showStationsOnMap(filtered);
    }

    function removeRadius() {
      radiusActive = false;
      if (currentRadiusCircle) map.removeLayer(currentRadiusCircle);
      if (currentCenterMarker) map.removeLayer(currentCenterMarker);
      currentRadiusCircle = null;
      currentCenterMarker = null;
      handleMapMove(); // Zurück zur BBox
    }

    // ============ HAVERSINE =================
    function getDistance(lat1, lon1, lat2, lon2) {
      var R = 6371;
      var dLat = (lat2 - lat1) * Math.PI / 180;
      var dLon = (lon2 - lon1) * Math.PI / 180;
      var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
              Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
              Math.sin(dLon/2)*Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // ============ KOORDINATEN-SUCHE (serverseitig) ============
    function searchByCoordinates() {
      var lat = parseFloat(document.getElementById("searchLat").value);
      var lng = parseFloat(document.getElementById("searchLng").value);
      var maxSt = parseInt(document.getElementById("maxStations").value, 10) || 10;
      radiusKm = parseFloat(document.getElementById("radius").value) || 50;

      if (isNaN(lat) || isNaN(lng)) {
        alert("Bitte gültige Werte für Lat/Lng eingeben!");
        return;
      }
      removeRadius(); 
      radiusActive = true; 

      showLoading();
      var url = `/search_by_coords?lat=${lat}&lng=${lng}&radius=${radiusKm}&limit=${maxSt}`;
      fetch(url)
        .then(r => {
          if (!r.ok) throw new Error("Fehler /search_by_coords: " + r.statusText);
          return r.json();
        })
        .then(data => {
          currentTableData = data;
          populateStationTable(data);
          showStationsOnMap(data);
          drawRadiusOnMap(lat, lng);

          if (data.length > 0) {
            map.setView([lat, lng], 10);
          }
        })
        .catch(err => {
          console.error("searchByCoordinates Fehler:", err);
          alert("Fehler bei Koord-Suche (siehe Konsole).");
        })
        .finally(() => hideLoading());
    }

    function drawRadiusOnMap(centerLat, centerLng) {
      if (currentRadiusCircle) map.removeLayer(currentRadiusCircle);
      if (currentCenterMarker) map.removeLayer(currentCenterMarker);

      currentRadiusCircle = L.circle([centerLat, centerLng], {
        radius: radiusKm * 1000,
        color: "blue",
        fillColor: "#add8e6",
        fillOpacity: 0.5
      }).addTo(map);

      currentCenterMarker = L.circleMarker([centerLat, centerLng], {
        radius: 5,
        color: "red",
        fillColor: "red",
        fillOpacity: 1
      }).addTo(map);
    }
  </script>
</body>
</html>
